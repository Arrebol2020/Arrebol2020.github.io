---
layout: post
title: TinyWebServer ç›¸å…³å‡½æ•°ä½¿ç”¨ä¸æ ·ä¾‹ [httpè¿æ¥å¤„ç† ä¸‹]
date: 2023-03-15 11:38 +0800
categories:
- é¡¹ç›®
- TinyWebServer
tags:
- C++
- http
---



## strpbrk å‡½æ•°

`strpbrk`å‡½æ•°ç”¨äºåœ¨ä¸€ä¸ªå­—ç¬¦ä¸²ä¸­æŸ¥æ‰¾ç»™å®šå­—ç¬¦é›†åˆä¸­ä»»æ„ä¸€ä¸ªå­—ç¬¦çš„ç¬¬ä¸€ä¸ªåŒ¹é…ä½ç½®ã€‚

å‡½æ•°å£°æ˜å¦‚ä¸‹ï¼š

```c++
char* strpbrk(const char* str1, const char* str2);
```

å‡½æ•°å‚æ•°ï¼š

- `str1`ï¼šæŒ‡å‘è¦åœ¨å…¶ä¸­æœç´¢çš„ C å­—ç¬¦ä¸²ã€‚
- `str2`ï¼šæŒ‡å‘åŒ…å«è¦åœ¨ `str1` ä¸­æŸ¥æ‰¾çš„å­—ç¬¦é›†åˆçš„ C å­—ç¬¦ä¸²ã€‚

å‡½æ•°è¿”å›å€¼ï¼š

- å¦‚æœæ‰¾åˆ°ä¸€ä¸ªå­—ç¬¦é›†åˆä¸­çš„å­—ç¬¦ï¼Œåˆ™è¿”å›æŒ‡å‘è¯¥å­—ç¬¦çš„æŒ‡é’ˆã€‚
- å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™è¿”å›ç©ºæŒ‡é’ˆã€‚

ç¤ºä¾‹ä»£ç ï¼š

```c++
#include <iostream>
#include <cstring>

using namespace std;

int main()
{
    char str1[] = "This is a sample string";
    char str2[] = "aeiou";

    char* p = strpbrk(str1, str2);

    if (p != nullptr)
        cout << "First vowel in str1: " << *p << endl;
    else
        cout << "No vowels in str1" << endl;

    return 0;
}
```

è¾“å‡ºï¼š

```bash
First vowel in str1: i
```

> ä¸ºä»€ä¹ˆè¾“å‡º i

å› ä¸º str2 çš„å€¼ä¸º `aeiou`ï¼Œè€Œ `i`  åœ¨ str1 å…ˆå‡ºç°ï¼Œæ‰€ä»¥è¾“å‡ºä¸º `i`



## strcasecmp å‡½æ•°

`strcasecmp` å‡½æ•°æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æ¯”è¾ƒå‡½æ•°ï¼Œç”¨äºæ¯”è¾ƒä¸¤ä¸ªå­—ç¬¦ä¸²æ˜¯å¦ç›¸ç­‰ï¼Œä¸è€ƒè™‘å¤§å°å†™ã€‚

å‡½æ•°åŸå‹å¦‚ä¸‹ï¼š

```c++
int strcasecmp(const char* s1, const char* s2);
```

å…¶ä¸­ `s1` å’Œ `s2` ä¸ºè¦æ¯”è¾ƒçš„ä¸¤ä¸ªå­—ç¬¦ä¸²ã€‚

å‡½æ•°è¿”å›å€¼ä¸ºï¼š

- è‹¥ `s1` å’Œ `s2` ç›¸ç­‰ï¼Œè¿”å›å€¼ä¸º `0`ã€‚
- è‹¥ `s1` å¤§äº `s2`ï¼Œè¿”å›å€¼å¤§äº `0`ã€‚
- è‹¥ `s1` å°äº `s2`ï¼Œè¿”å›å€¼å°äº `0`ã€‚

å‡½æ•°çš„æ¯”è¾ƒè§„åˆ™å¦‚ä¸‹ï¼š

- å¿½ç•¥å¤§å°å†™ã€‚
- ä»¥ ASCII ç å€¼ä¸ºæ ‡å‡†è¿›è¡Œæ¯”è¾ƒã€‚

ç¤ºä¾‹ä»£ç ï¼š

```c++
#include <iostream>
#include <cstring>

int main()
{
    const char* s1 = "Hello";
    const char* s2 = "hello";
    int result = strcasecmp(s1, s2);
    std::cout << result << std::endl;
    return 0;
}
```

ä¸Šè¿°ä»£ç ä¸­ï¼Œ`s1` å’Œ `s2` ä¸ç›¸ç­‰ï¼Œä½†ç”±äºå¿½ç•¥å¤§å°å†™ï¼Œæ‰€ä»¥å‡½æ•°è¿”å›å€¼ä¸º `0`ã€‚



## strspn å‡½æ•°

 `strspn` å‡½æ•°ç”¨äºè®¡ç®—å­—ç¬¦ä¸²ä¸­è¿ç»­å­—ç¬¦é›†åˆçš„é•¿åº¦ï¼Œå³è¿”å›ä¸€ä¸ªæŒ‡å‘ `s` ä¸­ç¬¬ä¸€ä¸ªä¸åœ¨ `accept` ä¸­å‡ºç°çš„å­—ç¬¦çš„æŒ‡é’ˆã€‚

è¯¥å‡½æ•°çš„åŸå‹å¦‚ä¸‹ï¼š

```c++
size_t strspn(const char* s, const char* accept);
```

å…¶ä¸­ï¼Œ`s` è¡¨ç¤ºè¦è®¡ç®—çš„å­—ç¬¦ä¸²ï¼Œ`accept` è¡¨ç¤ºè¦åŒ¹é…çš„å­—ç¬¦é›†åˆã€‚å‡½æ•°è¿”å›å€¼æ˜¯ä¸€ä¸ª `size_t` ç±»å‹ï¼Œè¡¨ç¤ºå­—ç¬¦ä¸²ä¸­è¿ç»­å­—ç¬¦é›†åˆçš„é•¿åº¦ã€‚

å‡½æ•°å®ç°çš„è¿‡ç¨‹æ˜¯ä» `s` çš„å¼€å¤´å¼€å§‹ï¼ŒæŸ¥æ‰¾å®ƒæ‰€åŒ…å«çš„å­—ç¬¦é›†åˆï¼ˆå³ `accept` ä¸­çš„å­—ç¬¦é›†åˆï¼‰ï¼Œç›´åˆ°æ‰¾åˆ°ç¬¬ä¸€ä¸ªä¸åœ¨å­—ç¬¦é›†åˆä¸­çš„å­—ç¬¦ä¸ºæ­¢ï¼Œè¿”å›è¿™ä¸ªå­—ç¬¦ä¹‹å‰è¿ç»­å­—ç¬¦é›†åˆçš„é•¿åº¦ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œæ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨ `strspn` å‡½æ•°ï¼š

```c++
#include <iostream>
#include <cstring>

int main()
{
    const char* s = "Hello, world!";
    const char* accept = "Helo, wrd";
    size_t len = strspn(s, accept);
    std::cout << "The length of the first span in " << s << " is " << len << std::endl;
    return 0;
}
```

ä¸Šè¿°ä»£ç å°†è¾“å‡ºï¼š

```bash
The length of the first span in Hello, world! is 12
```

è¿™è¯´æ˜äº† `s` ä¸­å‰ 12 ä¸ªå­—ç¬¦éƒ½å±äº `accept` å­—ç¬¦é›†åˆä¸­çš„å­—ç¬¦ã€‚



## strncasecmp å‡½æ•°

`strncasecmp` å‡½æ•°ç”¨äºæ¯”è¾ƒä¸¤ä¸ªå­—ç¬¦ä¸²çš„å‰ n ä¸ªå­—ç¬¦ï¼Œå¿½ç•¥å¤§å°å†™ã€‚

å‡½æ•°å£°æ˜å¦‚ä¸‹ï¼š

```c++
int strncasecmp(const char* s1, const char* s2, size_t n);
```

å‚æ•°è¯´æ˜ï¼š

- `s1`ï¼šè¦æ¯”è¾ƒçš„å­—ç¬¦ä¸²ä¹‹ä¸€ã€‚
- `s2`ï¼šè¦æ¯”è¾ƒçš„å­—ç¬¦ä¸²ä¹‹äºŒã€‚
- `n`ï¼šè¦æ¯”è¾ƒçš„å­—ç¬¦æ•°ã€‚

è¿”å›å€¼ï¼š

- è‹¥ s1 çš„å‰ n ä¸ªå­—ç¬¦ï¼ˆä¸åŒ…æ‹¬ç»“æŸç¬¦ '\0'ï¼‰å­—å…¸åºå°äº s2ï¼Œåˆ™è¿”å›è´Ÿæ•°ã€‚
- è‹¥ s1 çš„å‰ n ä¸ªå­—ç¬¦ï¼ˆä¸åŒ…æ‹¬ç»“æŸç¬¦ '\0'ï¼‰å­—å…¸åºå¤§äº s2ï¼Œåˆ™è¿”å›æ­£æ•°ã€‚
- è‹¥ s1 çš„å‰ n ä¸ªå­—ç¬¦ï¼ˆä¸åŒ…æ‹¬ç»“æŸç¬¦ '\0'ï¼‰ä¸ s2 ç›¸ç­‰ï¼Œåˆ™è¿”å› 0ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ`strncasecmp` å‡½æ•°æ˜¯åœ¨ POSIX æ ‡å‡†ä¸­å®šä¹‰çš„ï¼Œè€Œä¸æ˜¯æ ‡å‡†çš„ C++ å‡½æ•°ã€‚å› æ­¤ï¼Œåœ¨æŸäº›æ“ä½œç³»ç»Ÿä¸Šå¯èƒ½éœ€è¦å®šä¹‰ `_POSIX_C_SOURCE` å®æˆ–è€…å…¶ä»–ç±»ä¼¼çš„å®æ¥å¯ç”¨è¿™ä¸ªå‡½æ•°ã€‚åœ¨ Linux ä¸Šï¼Œä¸€èˆ¬åœ¨æºæ–‡ä»¶å¼€å¤´åŠ ä¸Š `#define _GNU_SOURCE` å³å¯ã€‚



ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨ `strncasecmp` å‡½æ•°æ¯”è¾ƒä¸¤ä¸ªå­—ç¬¦ä¸²å¿½ç•¥å¤§å°å†™çš„ä¾‹å­ï¼š

```c++
#include <iostream>
#include <cstring>

int main() {
    char str1[] = "hello world";
    char str2[] = "Hello World";

    // æ¯”è¾ƒä¸¤ä¸ªå­—ç¬¦ä¸²å‰äº”ä¸ªå­—ç¬¦å¿½ç•¥å¤§å°å†™æ˜¯å¦ç›¸åŒ
    int result = strncasecmp(str1, str2, 5);
    if (result == 0) {
        std::cout << "å‰äº”ä¸ªå­—ç¬¦ç›¸åŒ" << std::endl;
    } else {
        std::cout << "å‰äº”ä¸ªå­—ç¬¦ä¸åŒ" << std::endl;
    }

    return 0;
}
```

è¾“å‡ºç»“æœä¸ºï¼š

```bash
å‰äº”ä¸ªå­—ç¬¦ç›¸åŒ
```



## stat å‡½æ•°

`stat` å‡½æ•°ç”¨äºè·å–æ–‡ä»¶çš„ç›¸å…³ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ–‡ä»¶å¤§å°ã€æ–‡ä»¶åˆ›å»ºæ—¶é—´ã€æ–‡ä»¶æœ€åä¿®æ”¹æ—¶é—´ç­‰ã€‚å…¶å‡½æ•°åŸå‹å¦‚ä¸‹ï¼š

```c++
int stat(const char *path, struct stat *buf);
```

å…¶ä¸­ï¼Œ`path` å‚æ•°ä¸ºæ–‡ä»¶è·¯å¾„ï¼Œ`buf` å‚æ•°ä¸ºç”¨äºä¿å­˜æ–‡ä»¶ä¿¡æ¯çš„ç»“æ„ä½“æŒ‡é’ˆã€‚

`stat` å‡½æ•°æ‰§è¡ŒæˆåŠŸæ—¶è¿”å› 0ï¼Œæ‰§è¡Œå¤±è´¥æ—¶è¿”å› -1ï¼Œå¹¶å°†é”™è¯¯ç å­˜å…¥ `errno` å˜é‡ä¸­ã€‚

ç»“æ„ä½“ `stat`

```c++
struct stat 
{
   mode_t    st_mode;        /* æ–‡ä»¶ç±»å‹å’Œæƒé™ */
   off_t     st_size;        /* æ–‡ä»¶å¤§å°ï¼Œå­—èŠ‚æ•°*/
};
```



ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹ä»£ç ï¼Œç”¨äºè·å–æ–‡ä»¶å¤§å°å’Œæœ€åä¿®æ”¹æ—¶é—´ï¼š

```c++
#include <iostream>
#include <sys/stat.h>
#include <unistd.h>

int main()
{
    const char* filename = "test.txt";
    struct stat st;
    if (stat(filename, &st) != 0)
    {
        std::cerr << "Failed to get file info\n";
        return -1;
    }

    std::cout << "File size: " << st.st_size << " bytes\n";
    std::cout << "Last modified time: " << ctime(&st.st_mtime);
    return 0;
}
```

å…¶ä¸­ï¼Œ`ctime` å‡½æ•°ç”¨äºå°†æ—¶é—´æˆ³è½¬æ¢ä¸ºå¯è¯»çš„å­—ç¬¦ä¸²æ ¼å¼ã€‚



## mmap å‡½æ•°

`mmap()` å‡½æ•°æ˜¯ä¸€ç§å†…å­˜æ˜ å°„æ–‡ä»¶çš„æ–¹æ³•ï¼Œå¯ä»¥æŠŠä¸€ä¸ªæ–‡ä»¶æˆ–è€…ä¸€ä¸ªè®¾å¤‡æ˜ å°„åˆ°è¿›ç¨‹çš„åœ°å€ç©ºé—´ä¸­ï¼Œä½¿å¾—è¿›ç¨‹å¯ä»¥åƒè®¿é—®å†…å­˜ä¸€æ ·è®¿é—®è¿™ä¸ªæ–‡ä»¶æˆ–è€…è®¾å¤‡ã€‚`mmap()` å‡½æ•°åœ¨ Linux å’Œ Unix ç³»ç»Ÿä¸‹éå¸¸å¸¸ç”¨ï¼Œå¯ä»¥å®ç°å¾ˆå¤šé«˜æ•ˆçš„æ–‡ä»¶å’Œæ•°æ®æ“ä½œã€‚`mmap()` å‡½æ•°çš„åŸå‹å¦‚ä¸‹ï¼š

```c++
#include <sys/mman.h>
void *mmap(void *addr, size_t length, int prot, int flags, int fd, off_t offset);
```

å‚æ•°å«ä¹‰å¦‚ä¸‹ï¼š

- `addr`ï¼šæŒ‡å®šæ˜ å°„åŒºçš„èµ·å§‹åœ°å€ï¼Œé€šå¸¸è®¾ä¸º `NULL`ã€‚
- `length`ï¼šæŒ‡å®šæ˜ å°„åŒºçš„é•¿åº¦ï¼Œå•ä½æ˜¯å­—èŠ‚ã€‚
- `prot`ï¼šæŒ‡å®šæ˜ å°„åŒºçš„ä¿æŠ¤æ–¹å¼ï¼Œå¯å–å€¼ä¸º `PROT_READ`ã€`PROT_WRITE`ã€`PROT_EXEC` å’Œ `PROT_NONE`ï¼Œåˆ†åˆ«è¡¨ç¤ºå¯è¯»ã€å¯å†™ã€å¯æ‰§è¡Œå’Œä¸å¯è®¿é—®ã€‚å¯ä»¥ä½¿ç”¨é€»è¾‘æˆ–ï¼ˆ`|`ï¼‰å°†å®ƒä»¬ç»„åˆä½¿ç”¨ã€‚
- `flags`ï¼šæŒ‡å®šæ˜ å°„åŒºçš„ç±»å‹å’Œå„ç§å±æ€§ã€‚ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§å–å€¼ï¼š
  - `MAP_SHARED`ï¼šæ˜ å°„åŒºåŸŸä¸å…¶ä»–è¿›ç¨‹å…±äº«ï¼Œå¹¶ä¸”ä¿®æ”¹æ˜¯å¯è§çš„ã€‚
  - `MAP_PRIVATE`ï¼šåˆ›å»ºä¸€ä¸ªå†™æ—¶å¤åˆ¶çš„ç§æœ‰æ˜ å°„åŒºï¼Œæ˜ å°„åŒºçš„å†…å®¹å¯¹è¿›ç¨‹æ˜¯ç§æœ‰çš„ï¼Œè¿›ç¨‹é—´ä¸å¯è§ã€‚
  - `MAP_FIXED`ï¼šå°è¯•å°†æ˜ å°„åŒºåŸŸæ”¾åˆ°æŒ‡å®šåœ°å€ä¸Šã€‚å¦‚æœè¯¥åœ°å€å·²è¢«å ç”¨æˆ–è€…ä¸ç¬¦åˆç³»ç»Ÿè¦æ±‚ï¼Œåˆ™ä¼šå¯¼è‡´æ˜ å°„å¤±è´¥ã€‚
  - `MAP_ANONYMOUS`ï¼šä¸ä½¿ç”¨æ–‡ä»¶ï¼Œè€Œæ˜¯åˆ›å»ºä¸€ä¸ªåŒ¿åçš„æ˜ å°„åŒºï¼Œæ˜ å°„åŒºçš„å†…å®¹è¢«åˆå§‹åŒ–ä¸º 0ã€‚
- `fd`ï¼šæŒ‡å®šè¦æ˜ å°„çš„æ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ã€‚å¦‚æœæŒ‡å®šä¸º `-1`ï¼Œåˆ™è¡¨ç¤ºä¸ä½¿ç”¨æ–‡ä»¶ï¼Œè€Œæ˜¯åˆ›å»ºä¸€ä¸ªåŒ¿åçš„æ˜ å°„åŒºã€‚
- `offset`ï¼šæŒ‡å®šè¦æ˜ å°„çš„æ–‡ä»¶çš„åç§»é‡ï¼Œå•ä½æ˜¯å­—èŠ‚ã€‚

`mmap()` å‡½æ•°æ‰§è¡ŒæˆåŠŸåä¼šè¿”å›æ˜ å°„åŒºçš„é¦–åœ°å€ï¼Œé€šå¸¸éœ€è¦å°†è¿”å›å€¼è¿›è¡Œå¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œä¾‹å¦‚ï¼š

```c++
char *addr = static_cast<char *>(mmap(NULL, size, PROT_READ | PROT_WRITE, MAP_SHARED, fd, 0));
```

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä½¿ç”¨ `mmap()` å‡½æ•°æ˜ å°„çš„åŒºåŸŸå¿…é¡»ä½¿ç”¨ `munmap()` å‡½æ•°è¿›è¡Œè§£é™¤æ˜ å°„ï¼Œå¦åˆ™ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ã€‚åŒæ—¶ï¼Œä½¿ç”¨ `mmap()` å‡½æ•°æ˜ å°„çš„æ–‡ä»¶å¿…é¡»ä½¿ç”¨ `close()` å‡½æ•°å…³é—­ï¼Œå¦åˆ™ä¼šå¯¼è‡´æ–‡ä»¶æè¿°ç¬¦æ³„æ¼ã€‚



æ ·ä¾‹ï¼š

```c++
#include <iostream>
#include <fcntl.h>
#include <sys/mman.h>
#include <sys/stat.h>
#include <unistd.h>

int main() {
  const char* filename = "test.txt";
  int fd = open(filename, O_RDONLY);
  if (fd == -1) {
    std::cerr << "Failed to open file " << filename << std::endl;
    return 1;
  }

  struct stat file_stat;
  if (fstat(fd, &file_stat) == -1) {
    std::cerr << "Failed to get file status for " << filename << std::endl;
    close(fd);
    return 1;
  }

  char* file_data = static_cast<char*>(
      mmap(nullptr, file_stat.st_size, PROT_READ, MAP_PRIVATE, fd, 0));
  if (file_data == MAP_FAILED) {
    std::cerr << "Failed to mmap file " << filename << std::endl;
    close(fd);
    return 1;
  }

  // ä» file_data ä¸­è¯»å–æ–‡ä»¶å†…å®¹
  std::cout << "File content: " << std::endl << file_data << std::endl;

  munmap(file_data, file_stat.st_size);
  close(fd);
  return 0;
}

```

è¯¥ç¤ºä¾‹ä»£ç æ‰“å¼€åä¸º `test.txt` çš„æ–‡ä»¶ï¼Œä½¿ç”¨ `fstat` è·å–æ–‡ä»¶å¤§å°ï¼Œå¹¶ä½¿ç”¨ `mmap` å°†æ–‡ä»¶æ˜ å°„åˆ°å†…å­˜ä¸­ã€‚æœ€åï¼Œç¨‹åºä»æ˜ å°„çš„å†…å­˜ä¸­è¯»å–æ–‡ä»¶å†…å®¹ï¼Œå¹¶åœ¨ç»“æŸå‰ä½¿ç”¨ `munmap` å…³é—­æ˜ å°„ã€‚



## iovec å‡½æ•°

C++ä¸­çš„`iovec`ç»“æ„ä½“å®šä¹‰åœ¨å¤´æ–‡ä»¶`<sys/uio.h>`ä¸­ï¼Œç”¨äºæè¿°ä¸€ä¸ªè¿ç»­å†…å­˜å—çš„åœ°å€å’Œé•¿åº¦ã€‚

`iovec`ç»“æ„ä½“çš„å®šä¹‰å¦‚ä¸‹ï¼š

```c++
struct iovec {
    void *iov_base; // å†…å­˜å—åœ°å€
    size_t iov_len; // å†…å­˜å—é•¿åº¦
};
```

`iovec`ç»“æ„ä½“å¸¸ç”¨äº`readv()`ã€`writev()`å’Œ`recvmsg()`ã€`sendmsg()`ç­‰ç³»ç»Ÿè°ƒç”¨ä¸­ï¼Œç”¨äºå°†å¤šä¸ªç¼“å†²åŒºçš„æ•°æ®è¯»å…¥åˆ°ä¸€ä¸ªç¼“å†²åŒºï¼Œæˆ–å°†ä¸€ä¸ªç¼“å†²åŒºçš„æ•°æ®å†™å…¥åˆ°å¤šä¸ªç¼“å†²åŒºã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨`iovec`çš„ç¤ºä¾‹ï¼š

```c++
#include <sys/uio.h>
#include <iostream>
#include <cstring>
#include <unistd.h>

int main()
{
    char buf1[] = "hello ";
    char buf2[] = "world\n";

    struct iovec iov[2];
    iov[0].iov_base = buf1;
    iov[0].iov_len = strlen(buf1);
    iov[1].iov_base = buf2;
    iov[1].iov_len = strlen(buf2);
    ssize_t nwritten = writev(STDOUT_FILENO, iov, 2);
    std::cout << "wrote " << nwritten << " bytes" << std::endl;
    return 0;
}
```

ä»¥ä¸Šç¤ºä¾‹å°†ä¸¤ä¸ªç¼“å†²åŒºçš„æ•°æ®ä¾æ¬¡è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºä¸­ã€‚é¦–å…ˆå®šä¹‰äº†ä¸¤ä¸ª`char`æ•°ç»„ï¼Œç„¶åå®šä¹‰äº†ä¸€ä¸ªé•¿åº¦ä¸º2çš„`iovec`æ•°ç»„ï¼Œå…¶ä¸­æ¯ä¸ªå…ƒç´ éƒ½æè¿°äº†ä¸€ä¸ªç¼“å†²åŒºçš„åœ°å€å’Œé•¿åº¦ã€‚æœ€åä½¿ç”¨`writev()`å°†è¿™ä¸¤ä¸ªç¼“å†²åŒºçš„æ•°æ®ä¾æ¬¡å†™å…¥åˆ°æ ‡å‡†è¾“å‡ºä¸­ã€‚è¿è¡Œè¯¥ç¨‹åºï¼Œè¾“å‡ºç»“æœä¸ºï¼š

```bash
hello world
wrote 12 bytes
```



## writev å‡½æ•°

`writev()` å‡½æ•°æ˜¯ POSIX æ ‡å‡†ä¸­å®šä¹‰çš„ä¸€ç§è¾“å…¥è¾“å‡ºå‡½æ•°ï¼Œç”¨äºå°†å¤šå—æ•°æ®åŒæ—¶å†™å…¥æ–‡ä»¶æè¿°ç¬¦ä¸­ã€‚è¯¥å‡½æ•°çš„åŸå‹å¦‚ä¸‹ï¼š

```c++
#include <sys/uio.h>
ssize_t writev(int fd, const struct iovec *iov, int iovcnt);
```

å…¶ä¸­ï¼Œå‚æ•° `fd` è¡¨ç¤ºæ–‡ä»¶æè¿°ç¬¦ï¼Œ`iov` æ˜¯ä¸€ä¸ª `iovec` ç»“æ„ä½“æ•°ç»„ï¼Œ`iovcnt` è¡¨ç¤º `iov` æ•°ç»„ä¸­å…ƒç´ çš„ä¸ªæ•°ã€‚

`iovec` ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š

```c++
struct iovec {
    void  *iov_base; // å†…å­˜åœ°å€
    size_t iov_len;  // æ•°æ®é•¿åº¦
};
```

`writev()` å‡½æ•°ä¼šå°† `iov` æ•°ç»„ä¸­çš„å¤šå—æ•°æ®ä¾æ¬¡å†™å…¥æ–‡ä»¶æè¿°ç¬¦ `fd` ä¸­ï¼Œä»è€Œå®Œæˆä¸€æ¬¡å†™å…¥æ“ä½œã€‚å…·ä½“æ¥è¯´ï¼Œ`iov` æ•°ç»„ä¸­æ¯ä¸ªå…ƒç´ çš„ `iov_base` æŒ‡å‘æ•°æ®å—çš„èµ·å§‹åœ°å€ï¼Œ`iov_len` è¡¨ç¤ºæ•°æ®å—çš„é•¿åº¦ã€‚

å®ä¾‹å‚è€ƒ `iovec` å‡½æ•°



> å¾ªç¯è°ƒç”¨ writev æ—¶ï¼Œéœ€è¦é‡æ–°å¤„ç† iovec ä¸­çš„æŒ‡é’ˆå’Œé•¿åº¦ï¼Œè¯¥å‡½æ•°ä¸ä¼šå¯¹è¿™ä¸¤ä¸ªæˆå‘˜åšä»»ä½•å¤„ç†ã€‚writev çš„è¿”å›å€¼ä¸ºå·²å†™çš„å­—èŠ‚æ•°ï¼Œä½†è¿™ä¸ªè¿”å›å€¼â€œå®ç”¨æ€§â€å¹¶ä¸é«˜ï¼Œå› ä¸ºå‚æ•°ä¼ å…¥çš„æ˜¯ iovec æ•°ç»„ï¼Œè®¡é‡å•ä½æ˜¯ iovcnt ï¼Œè€Œä¸æ˜¯å­—èŠ‚æ•°ï¼Œæˆ‘ä»¬ä»ç„¶éœ€è¦é€šè¿‡éå† iovec æ¥è®¡ç®—æ–°çš„åŸºå€ï¼Œå¦å¤– å†™å…¥æ•°æ®çš„â€œç»“æŸç‚¹â€å¯èƒ½ä½äºä¸€ä¸ª iovec çš„ä¸­é—´æŸä¸ªä½ç½®ï¼Œå› æ­¤éœ€è¦è°ƒæ•´ä¸´ç•Œ iovec çš„ io_base å’Œ io_lenã€‚
> {: .prompt-warning }



## strrchr å‡½æ•°

`strrchr` å‡½æ•°ç”¨äºæŸ¥æ‰¾æŒ‡å®šå­—ç¬¦åœ¨ä¸€ä¸ª C é£æ ¼å­—ç¬¦ä¸²ä¸­æœ€åä¸€æ¬¡å‡ºç°çš„ä½ç½®ï¼Œå¦‚æœæ‰¾åˆ°ï¼Œåˆ™è¿”å›è¯¥ä½ç½®çš„æŒ‡é’ˆï¼Œå¦åˆ™è¿”å› `NULL`ã€‚å…¶å‡½æ•°å£°æ˜å¦‚ä¸‹ï¼š

```c++
char *strrchr(const char *str, int c);
```

å…¶ä¸­ï¼Œ`str` è¡¨ç¤ºå¾…æŸ¥æ‰¾çš„å­—ç¬¦ä¸²ï¼Œ`c` è¡¨ç¤ºå¾…æŸ¥æ‰¾çš„å­—ç¬¦ã€‚

`strrchr` å‡½æ•°ä¼šåœ¨ `str` æŒ‡å‘çš„å­—ç¬¦ä¸²ä¸­ä»åå¾€å‰æŸ¥æ‰¾å­—ç¬¦ `c`ï¼Œç›´åˆ°æ‰¾åˆ°è¯¥å­—ç¬¦æˆ–è€…åˆ°è¾¾å­—ç¬¦ä¸²çš„èµ·å§‹ä½ç½®ä¸ºæ­¢ã€‚å¦‚æœæ‰¾åˆ°äº†å­—ç¬¦ `c`ï¼Œåˆ™è¿”å›è¯¥ä½ç½®çš„æŒ‡é’ˆï¼›å¦åˆ™è¿”å› `NULL`ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨ `strrchr` å‡½æ•°çš„ç¤ºä¾‹ä»£ç ï¼š

```c++
#include <iostream>
#include <cstring>

int main() {
    const char* str = "hello, world!";
    const char* p = strrchr(str, 'o');
    if (p != NULL) {
        std::cout << "The last occurrence of 'o' is at position " << p - str << std::endl;
    } else {
        std::cout << "The character 'o' is not found." << std::endl;
    }
    return 0;
}
```

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆå®šä¹‰äº†ä¸€ä¸ª C é£æ ¼å­—ç¬¦ä¸² `str`ï¼Œç„¶åè°ƒç”¨ `strrchr` å‡½æ•°æŸ¥æ‰¾å­—ç¬¦ `o` æœ€åä¸€æ¬¡å‡ºç°çš„ä½ç½®ã€‚å¦‚æœæ‰¾åˆ°äº†ï¼Œåˆ™æ‰“å°è¯¥ä½ç½®çš„ä¸‹æ ‡ï¼›å¦åˆ™è¾“å‡ºæç¤ºä¿¡æ¯ã€‚



## strncpy å‡½æ•°

`strncpy` æ˜¯ C/C++ æ ‡å‡†åº“æä¾›çš„ä¸€ä¸ªå­—ç¬¦ä¸²æ‹·è´å‡½æ•°ï¼Œç”¨äºå°†æºå­—ç¬¦ä¸²çš„ä¸€éƒ¨åˆ†æ‹·è´åˆ°ç›®æ ‡å­—ç¬¦ä¸²ä¸­ã€‚å…¶å‡½æ•°åŸå‹ä¸ºï¼š

```c++
char *strncpy(char *dest, const char *src, size_t n);
```

å…¶ä¸­ `dest` ä¸ºç›®æ ‡å­—ç¬¦ä¸²çš„æŒ‡é’ˆï¼Œ`src` ä¸ºæºå­—ç¬¦ä¸²çš„æŒ‡é’ˆï¼Œ`n` è¡¨ç¤ºéœ€è¦æ‹·è´çš„å­—ç¬¦ä¸ªæ•°ã€‚

å¦‚æœæºå­—ç¬¦ä¸²çš„é•¿åº¦å°äº `n`ï¼Œåˆ™ä¼šå°†æ•´ä¸ªæºå­—ç¬¦ä¸²æ‹·è´åˆ°ç›®æ ‡å­—ç¬¦ä¸²ä¸­ï¼Œç„¶åå°†å‰©ä½™çš„éƒ¨åˆ†ç”¨ `\0` è¡¥é½ï¼›å¦‚æœæºå­—ç¬¦ä¸²çš„é•¿åº¦å¤§äºæˆ–ç­‰äº `n`ï¼Œåˆ™åªä¼šæ‹·è´å‰ `n` ä¸ªå­—ç¬¦åˆ°ç›®æ ‡å­—ç¬¦ä¸²ä¸­ã€‚

> éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ`strncpy` ä¸ä¿è¯æ‹·è´åçš„ç›®æ ‡å­—ç¬¦ä¸²ä»¥ `\0` ç»“å°¾ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨åœ¨ç›®æ ‡å­—ç¬¦ä¸²çš„æœ«å°¾æ·»åŠ ä¸€ä¸ª `\0`ã€‹
> {: .prompt-warning }

å¦å¤–ï¼Œå¦‚æœ `src` æŒ‡å‘çš„å­—ç¬¦ä¸²é•¿åº¦å°äº `n`ï¼Œåˆ™ `strncpy` å¹¶ä¸ä¼šå°†å‰©ä½™éƒ¨åˆ†è¡¥é½ï¼Œè€Œæ˜¯å°†æœªæ‹·è´éƒ¨åˆ†ä¹Ÿå½“åšå­—ç¬¦ä¸²æ‹·è´è¿‡å»ï¼Œè¿™å¯èƒ½å¯¼è‡´ç›®æ ‡å­—ç¬¦ä¸²ä¸­å­˜åœ¨æ²¡æœ‰è¢«åˆå§‹åŒ–çš„å­—ç¬¦ï¼Œå› æ­¤ä½¿ç”¨æ—¶éœ€è¦æ³¨æ„ã€‚

ç¤ºä¾‹ï¼š

```c++
#include <iostream>
#include <cstring>

int main() {
    char src[] = "Hello, world!";
    char dest[20];
    strncpy(dest, src, 5);
    dest[5] = '\0'; // éœ€è¦æ‰‹åŠ¨æ·»åŠ  NULL å­—ç¬¦ï¼Œå› ä¸º strncpy ä¸ä¼šè‡ªåŠ¨æ·»åŠ 

    std::cout << "src: " << src << std::endl;
    std::cout << "dest: " << dest << std::endl;

    return 0;
}
```

è¾“å‡ºç»“æœï¼š

```bash
src: Hello, world!
dest: Hello
```



## S_ISDIR(m_file_stat.st_mode)

ç”¨äºåˆ¤æ–­ `m_file_stat` ç»“æ„ä½“æˆå‘˜ `st_mode` å¯¹åº”çš„æ–‡ä»¶ç±»å‹æ˜¯å¦ä¸ºç›®å½•ã€‚

åœ¨ Unix ç³»ç»Ÿä¸­ï¼Œæ–‡ä»¶ç±»å‹ä¿¡æ¯è¢«å­˜å‚¨åœ¨ `struct stat` ç»“æ„ä½“æˆå‘˜ `st_mode` ä¸­çš„ä½12ä½ã€‚å…¶ä¸­ï¼Œæ–‡ä»¶ç±»å‹ä¿¡æ¯å ç”¨äº†ä½4ä½ï¼Œæ–‡ä»¶è®¿é—®æƒé™å ç”¨äº†ä¸­é—´çš„9ä½ï¼Œé«˜4ä½æ˜¯ä¿ç•™ä½ã€‚é€šè¿‡å¯¹ `st_mode` çš„ä½è¿ç®—ï¼Œå¯ä»¥å¾—åˆ°æ–‡ä»¶çš„ç±»å‹ä¿¡æ¯å’Œè®¿é—®æƒé™ã€‚



## vsnprintf å‡½æ•°

`vsnprintf()` å‡½æ•°æ˜¯ C++ æ ‡å‡†åº“ä¸­çš„ä¸€ä¸ªå¯å˜å‚æ•°å‡½æ•°ï¼Œç”¨äºå°†å¯å˜å‚æ•°æ ¼å¼åŒ–æˆä¸€ä¸ªå­—ç¬¦ä¸²ã€‚

å‡½æ•°åŸå‹å¦‚ä¸‹ï¼š

```c++
int vsnprintf(char* str, size_t size, const char* format, va_list ap);
```

å‡½æ•°å‚æ•°ï¼š

- `str`ï¼šæŒ‡å‘ç”¨äºå­˜å‚¨æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„å­—ç¬¦æ•°ç»„çš„æŒ‡é’ˆ
- `size`ï¼šæŒ‡å®šå­˜å‚¨å­—ç¬¦ä¸²çš„å­—ç¬¦æ•°ç»„çš„é•¿åº¦ï¼ŒåŒ…æ‹¬ç»“å°¾çš„ç©ºå­—ç¬¦
- `format`ï¼šå­—ç¬¦ä¸²æ ¼å¼åŒ–æ§åˆ¶å‚æ•°
- `ap`ï¼šä¸€ä¸ªæŒ‡å‘å‚æ•°åˆ—è¡¨çš„ `va_list` å¯¹è±¡

å‡½æ•°è¿”å›å€¼ï¼šè¾“å‡ºåˆ°å­—ç¬¦æ•°ç»„ `str` ä¸­çš„å­—ç¬¦æ•°ï¼ˆä¸åŒ…æ‹¬ç»“å°¾çš„ç©ºå­—ç¬¦ï¼‰ï¼Œæˆ–è€…å¦‚æœè¾“å‡ºçš„å­—ç¬¦æ•°è¶…è¿‡äº† `size` åˆ™è¿”å›éœ€è¦å†™å…¥çš„å­—ç¬¦æ•°ï¼Œä¸åŒ…æ‹¬ç»“å°¾çš„ç©ºå­—ç¬¦ã€‚

ä½¿ç”¨ `vsnprintf()` å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥å°†ä¸€ä¸ªæ ¼å¼åŒ–çš„å­—ç¬¦ä¸²è¾“å‡ºåˆ°ä¸€ä¸ªå­—ç¬¦æ•°ç»„ä¸­ï¼Œå…·ä½“ç¤ºä¾‹å¦‚ä¸‹ï¼š

```c++
#include <cstdio>
#include <cstdarg>

void format_string(char* buffer, size_t size, const char* format, ...)
{
    va_list args;
    va_start(args, format);
    vsnprintf(buffer, size, format, args);
    va_end(args);
}

int main()
{
    char buffer[256];
    format_string(buffer, 256, "%s %d %s", "HTTP/1.1", 200, "OK");
    printf("%s\n", buffer);
    return 0;
}
```

ä¸Šè¿°ä»£ç å°† `"HTTP/1.1 200 OK"` è¾“å‡ºåˆ°äº†å­—ç¬¦æ•°ç»„ `buffer` ä¸­ï¼Œå¹¶æ‰“å°è¾“å‡ºäº†è¯¥å­—ç¬¦æ•°ç»„ã€‚æ³¨æ„åœ¨è°ƒç”¨ `vsnprintf()` å‡½æ•°ä¹‹å‰éœ€è¦å…ˆè°ƒç”¨ `va_start()` å‡½æ•°ï¼Œä¹‹ååœ¨å‡½æ•°ç»“æŸå‰è¿˜éœ€è¦è°ƒç”¨ `va_end()` å‡½æ•°ã€‚



## å‚è€ƒ

- [æœ€æ–°ç‰ˆWebæœåŠ¡å™¨é¡¹ç›®è¯¦è§£ - 05 httpè¿æ¥å¤„ç†ï¼ˆä¸­ï¼‰](https://mp.weixin.qq.com/s/wAQHU-QZiRt1VACMZZjNlw)
- [æœ€æ–°ç‰ˆWebæœåŠ¡å™¨é¡¹ç›®è¯¦è§£ - 06 httpè¿æ¥å¤„ç†ï¼ˆä¸‹ï¼‰](https://mp.weixin.qq.com/s/451xNaSFHxcxfKlPBV3OCg)



## å†™åœ¨æœ€å

æ„Ÿè°¢ä½ åœ¨èŒ«èŒ«äººæµ·ä¸­æ‰¾åˆ°æˆ‘ğŸ•µğŸ¼

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">

<span id="busuanzi_container_page_pv">ğŸ‰ä½ æ˜¯ç¬¬ <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i>  </span> ä¸ªè¯»è€…

ãŠ—ï¸ ä½ å¹³å®‰å–œä¹ï¼Œé¡ºé‚æ— å¿§ï¼

å¸Œæœ›ä½ è¯»å®Œæœ‰æ‰€æ”¶è·ï½

ğŸ¥‚ğŸ¥‚ğŸ¥‚ 
