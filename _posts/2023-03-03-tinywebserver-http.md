---
layout: post
title: TinyWebServer ç›¸å…³å‡½æ•°ä½¿ç”¨ä¸æ ·ä¾‹ [httpè¿æ¥å¤„ç†]
date: 2023-03-03 17:11 +0800
categories:
- é¡¹ç›®
- TinyWebServer
tags:
- C++
- http
---



## epoll_create å‡½æ•°

å‡½æ•°å®šä¹‰ï¼š

```c++
int epoll_create(int size);
```

å‚æ•°ï¼š

- `size`ï¼šepoll å®ä¾‹èƒ½å¤Ÿç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦æ•°é‡çš„ä¸Šé™ã€‚å®é™…ä¸Šè¿™ä¸ªå€¼å¹¶ä¸æ˜¯ç¡¬é™åˆ¶ï¼Œå†…æ ¸ä¼šä¸º epoll å®ä¾‹åŠ¨æ€åˆ†é…å†…å­˜ä»¥é€‚åº”æ›´å¤šçš„æ–‡ä»¶æè¿°ç¬¦ã€‚ä½† `size` å‚æ•°å¯ä»¥å½±å“ epoll å®ä¾‹åˆ†é…å†…å­˜çš„æ–¹å¼ã€‚

å¤´æ–‡ä»¶ï¼š

```c++
#include <sys/epoll.h>
```

è¿”å›å€¼ï¼š

- å¦‚æœæˆåŠŸï¼Œè¿”å› epoll å®ä¾‹çš„æ–‡ä»¶æè¿°ç¬¦ã€‚è¯¥æè¿°ç¬¦å¯ä»¥ç”¨äº `epoll_ctl()` å’Œ `epoll_wait()` å‡½æ•°ã€‚
- å¦‚æœå¤±è´¥ï¼Œè¿”å› -1ï¼Œå¹¶è®¾ç½®é”™è¯¯ç ï¼ˆerrnoï¼‰ã€‚



ç¤ºä¾‹ï¼š

```c++
#include <sys/epoll.h>
#include <unistd.h>
#include <iostream>

int main() {
    // åˆ›å»º epoll å®ä¾‹
    int epfd = epoll_create(10);
    if (epfd < 0) {
        std::cerr << "Failed to create epoll instance!" << std::endl;
        return 1;
    }
    std::cout << "Epoll instance created, fd = " << epfd << std::endl;

    // å…³é—­ epoll å®ä¾‹
    close(epfd);

    return 0;
}
```

è¯¥ç¤ºä¾‹ä¸­ï¼Œé¦–å…ˆé€šè¿‡ `epoll_create()` å‡½æ•°åˆ›å»ºä¸€ä¸ª epoll å®ä¾‹ï¼ŒæŒ‡å®šäº†èƒ½å¤Ÿç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦æ•°é‡çš„ä¸Šé™ä¸º 10ã€‚å¦‚æœæˆåŠŸåˆ›å»ºï¼Œå‡½æ•°è¿”å›å®ä¾‹çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå¦åˆ™è¿”å› -1ï¼Œå¹¶è®¾ç½®é”™è¯¯ç ã€‚å¦‚æœåˆ›å»ºæˆåŠŸï¼Œå¯ä»¥å°†è¯¥æè¿°ç¬¦ç”¨äºåç»­çš„ `epoll_ctl()` å’Œ `epoll_wait()` æ“ä½œã€‚æœ€åé€šè¿‡ `close()` å‡½æ•°å…³é—­ epoll å®ä¾‹ã€‚



## epoll_ctl å‡½æ•°

``epoll_ctl` æ˜¯ Linux ä¸­ä½¿ç”¨ epoll I/O æ¨¡å‹æ—¶çš„ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒç”¨äºå‘ epoll å®ä¾‹ä¸­æ·»åŠ ã€ä¿®æ”¹æˆ–åˆ é™¤æ–‡ä»¶æè¿°ç¬¦ã€‚

å‡½æ•°å®šä¹‰ï¼š

```c++
int epoll_ctl(int epfd, int op, int fd, struct epoll_event* event);
```

å‚æ•°è¯´æ˜ï¼š

- `epfd`ï¼šepoll å®ä¾‹çš„æ–‡ä»¶æè¿°ç¬¦Â·

- `op`ï¼šè¦è¿›è¡Œçš„æ“ä½œï¼ŒåŒ…æ‹¬ï¼š

  - `EPOLL_CTL_ADD`ï¼šå‘ epoll å®ä¾‹ä¸­æ·»åŠ ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦
  - `EPOLL_CTL_MOD`ï¼šä¿®æ”¹ epoll å®ä¾‹ä¸­å·²æœ‰çš„æ–‡ä»¶æè¿°ç¬¦
  - `EPOLL_CTL_DEL`ï¼šä» epoll å®ä¾‹ä¸­åˆ é™¤ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦

- `fd`ï¼šè¦æ·»åŠ ã€ä¿®æ”¹æˆ–åˆ é™¤çš„æ–‡ä»¶æè¿°ç¬¦

- `event`ï¼šå¯¹åº”çš„äº‹ä»¶ï¼Œä¸º `struct epoll_event` ç±»å‹çš„æŒ‡é’ˆ

  - `event`æ˜¯ epoll_event ç»“æ„ä½“æŒ‡é’ˆç±»å‹ï¼Œè¡¨ç¤ºå†…æ ¸æ‰€ç›‘å¬çš„äº‹ä»¶ï¼Œå…·ä½“å®šä¹‰å¦‚ä¸‹ï¼š

    ```c++
    struct epoll_event {
    __uint32_t events; /* Epoll events */
    epoll_data_t data; /* User data variable */
    };
    ```

    events æè¿°äº‹ä»¶ç±»å‹ï¼Œå…¶ä¸­ epoll äº‹ä»¶ç±»å‹æœ‰ä»¥ä¸‹å‡ ç§ï¼š

    - EPOLLINï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å¯ä»¥è¯»ï¼ˆåŒ…æ‹¬å¯¹ç«¯SOCKETæ­£å¸¸å…³é—­ï¼‰
    - EPOLLOUTï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å¯ä»¥å†™
    - EPOLLPRIï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦æœ‰ç´§æ€¥çš„æ•°æ®å¯è¯»ï¼ˆè¿™é‡Œåº”è¯¥è¡¨ç¤ºæœ‰å¸¦å¤–æ•°æ®åˆ°æ¥ï¼‰
    - EPOLLERRï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å‘ç”Ÿé”™è¯¯
    - EPOLLHUPï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦è¢«æŒ‚æ–­ï¼›
    - EPOLLETï¼šå°†EPOLLè®¾ä¸ºè¾¹ç¼˜è§¦å‘(Edge Triggered)æ¨¡å¼ï¼Œè¿™æ˜¯ç›¸å¯¹äºæ°´å¹³è§¦å‘(Level Triggered)è€Œè¨€çš„
    - EPOLLONESHOTï¼šåªç›‘å¬ä¸€æ¬¡äº‹ä»¶ï¼Œå½“ç›‘å¬å®Œè¿™æ¬¡äº‹ä»¶ä¹‹åï¼Œå¦‚æœè¿˜éœ€è¦ç»§ç»­ç›‘å¬è¿™ä¸ªsocketçš„è¯ï¼Œéœ€è¦å†æ¬¡æŠŠè¿™ä¸ªsocketåŠ å…¥åˆ°EPOLLé˜Ÿåˆ—é‡Œ

å‡½æ•°è¿”å›å€¼ï¼š

- æˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›-1ï¼Œé”™è¯¯ç ä¿å­˜åœ¨ errno ä¸­ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ä½¿ç”¨ `epoll_ctl` çš„ç¤ºä¾‹ï¼š

```c++
#include <sys/epoll.h>
#include <fcntl.h>
#include <unistd.h>
#include <iostream>
#include <cstring>

int main() {
    int epfd = epoll_create(10); // åˆ›å»º epoll å®ä¾‹
    if (epfd < 0) {
        std::cerr << "Failed to create epoll instance: " << std::strerror(errno) << std::endl;
        return -1;
    }

    int fd = open("test.txt", O_RDWR); // æ‰“å¼€æ–‡ä»¶
    if (fd < 0) {
        std::cerr << "Failed to open file: " << std::strerror(errno) << std::endl;
        return -1;
    }

    struct epoll_event ev;
    ev.data.fd = fd;
    ev.events = EPOLLIN | EPOLLOUT | EPOLLET;

    // æ·»åŠ æ–‡ä»¶æè¿°ç¬¦åˆ° epoll å®ä¾‹ä¸­
    if (epoll_ctl(epfd, EPOLL_CTL_ADD, fd, &ev) < 0) {
        std::cerr << "Failed to add fd to epoll instance: " << std::strerror(errno) << std::endl;
        return -1;
    }

    close(epfd);
    close(fd);
    return 0;
}
```

ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œé¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ª epoll å®ä¾‹ï¼Œç„¶åæ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼Œæ¥ç€å°†è¯¥æ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦æ·»åŠ åˆ° epoll å®ä¾‹ä¸­ï¼Œæœ€åå…³é—­æ–‡ä»¶æè¿°ç¬¦å’Œ epoll å®ä¾‹ã€‚



## epoll_wait å‡½æ•°

`epoll_wait` å‡½æ•°ç”¨äºç­‰å¾…å·²æ³¨å†Œçš„æ–‡ä»¶æè¿°ç¬¦ä¸Šçš„äº‹ä»¶ï¼Œå®ƒçš„å‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼š

```c++
int epoll_wait(int epfd, struct epoll_event *events, int maxevents, int timeout);
```

å…¶ä¸­å‚æ•°å«ä¹‰å¦‚ä¸‹ï¼š

- `epfd`: epollå®ä¾‹çš„æ–‡ä»¶æè¿°ç¬¦ã€‚
- `events`: å­˜å‚¨äº‹ä»¶çš„ç»“æ„ä½“æŒ‡é’ˆï¼Œæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå…¶å¤§å°åº”è¯¥ä¸º `maxevents`ã€‚
- `maxevents`: `events` æ•°ç»„çš„å¤§å°ï¼Œè¡¨ç¤ºæœŸæœ›çš„æœ€å¤§äº‹ä»¶æ•°é‡ã€‚
- `timeout`: è¶…æ—¶æ—¶é—´ï¼Œå•ä½ä¸ºæ¯«ç§’ã€‚å¦‚æœä¸ºè´Ÿæ•°ï¼Œåˆ™è¡¨ç¤ºä¸€ç›´ç­‰å¾…ï¼Œå¦‚æœä¸º0ï¼Œåˆ™è¡¨ç¤ºç«‹å³è¿”å›ï¼Œå¦‚æœå¤§äº0ï¼Œåˆ™è¡¨ç¤ºç­‰å¾…çš„æœ€é•¿æ—¶é—´ã€‚

å‡½æ•°è¿”å›å€¼ä¸ºå·²å°±ç»ªçš„äº‹ä»¶æ•°é‡ï¼Œå¦‚æœè¿”å›å€¼ä¸º0ï¼Œåˆ™è¡¨ç¤ºå·²è¶…æ—¶ã€‚å‡½æ•°æ‰§è¡Œå‡ºé”™æ—¶ï¼Œè¿”å›-1ï¼Œå¹¶è®¾ç½®errnoã€‚

ç®€å•çš„ä½¿ç”¨ç¤ºä¾‹ï¼š

```c++
#include <sys/epoll.h>
#include <unistd.h>
#include <iostream>

#define MAX_EVENTS 10

int main() {
    int epfd = epoll_create(1);
    if (epfd == -1) {
        perror("epoll_create error");
        return -1;
    }

    struct epoll_event ev, events[MAX_EVENTS];
    ev.data.fd = STDIN_FILENO;
    ev.events = EPOLLIN;

    if (epoll_ctl(epfd, EPOLL_CTL_ADD, STDIN_FILENO, &ev) == -1) {
        perror("epoll_ctl error");
        close(epfd);
        return -1;
    }

    while (true) {
        int nfds = epoll_wait(epfd, events, MAX_EVENTS, -1);
        if (nfds == -1) {
            perror("epoll_wait error");
            break;
        }

        for (int i = 0; i < nfds; i++) {
            if (events[i].data.fd == STDIN_FILENO) {
                char buf[1024];
                int n = read(STDIN_FILENO, buf, sizeof(buf));
                buf[n] = '\0';
                std::cout << "Read " << n << " bytes from stdin: " << buf;
            }
        }
    }

    close(epfd);
    return 0;
}
```

è¯¥ç¤ºä¾‹ä½¿ç”¨epollæ¥ç­‰å¾…æ ‡å‡†è¾“å…¥ä¸Šçš„äº‹ä»¶ï¼Œå½“è¾“å…¥æœ‰æ•°æ®åˆ°è¾¾æ—¶ï¼Œç¨‹åºå°†è¯»å–å¹¶è¾“å‡ºåˆ°æ§åˆ¶å°ã€‚



## select/poll/epoll

selectã€pollã€epoll éƒ½æ˜¯ Linux ä¸‹çš„ I/O å¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œç”¨äºå¤„ç†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆsocket æ–‡ä»¶å¥æŸ„ï¼‰çš„ I/O äº‹ä»¶ã€‚

å…¶ä¸­ select æ˜¯æœ€æ—©çš„ I/O å¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œä½†å®ƒæœ‰ä¸€ä¸ªé—®é¢˜æ˜¯å•ä¸ªè¿›ç¨‹æ‰€èƒ½æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦æœ‰é™ï¼Œå› ä¸ºå®ƒæ˜¯åŸºäºæ•°ç»„å®ç°çš„ï¼Œæ–‡ä»¶æè¿°ç¬¦çš„æ•°é‡å¤§å°ç”± FD_SETSIZE å†³å®šï¼Œé»˜è®¤æ˜¯ 1024ï¼Œå¯é€šè¿‡é‡æ–°ç¼–è¯‘å†…æ ¸æ¥ä¿®æ”¹ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œpoll åº”è¿è€Œç”Ÿã€‚poll æ²¡æœ‰æ–‡ä»¶æè¿°ç¬¦æ•°é‡çš„é™åˆ¶ï¼ŒåŸç†ä¸ select ç±»ä¼¼ï¼Œä½†æ˜¯å®ƒä¸æ˜¯åŸºäºæ•°ç»„å®ç°çš„ï¼Œè€Œæ˜¯åŸºäºé“¾è¡¨å®ç°çš„ã€‚

select å’Œ poll é€šè¿‡å°†æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦æ‹·è´åˆ°å†…æ ¸æ€ï¼Œæ¯æ¬¡è°ƒç”¨éƒ½éœ€è¦æ‹·è´ã€‚epoll é€šè¿‡ epoll_create å»ºç«‹ä¸€æ£µçº¢é»‘æ ‘ï¼Œé€šè¿‡ epoll_ctl å°†è¦ç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦æ³¨å†Œåˆ°çº¢é»‘æ ‘ä¸Š

epoll æ˜¯ Linux ä¸‹çš„æ–°ä¸€ä»£ I/O å¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œå®ƒçš„è®¾è®¡æ€æƒ³ä¸ poll ç›¸ä¼¼ï¼Œä½†æ›´åŠ é«˜æ•ˆï¼Œå…·ä½“ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

- æ”¯æŒä¸€ä¸ªè¿›ç¨‹æ‰“å¼€å¤§é‡çš„æ–‡ä»¶æè¿°ç¬¦ï¼ˆé»˜è®¤æœ€å¤§å¯ä»¥æ‰“å¼€ 1000 ä¸‡ä¸ªæè¿°ç¬¦ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹ç³»ç»Ÿå‚æ•°è¿›è¡Œè°ƒæ•´ï¼‰ã€‚

- ç›¸æ¯”è¾ƒäº select å’Œ pollï¼Œé‡‡ç”¨äº†äº‹ä»¶é€šçŸ¥çš„æœºåˆ¶ï¼Œå½“æ²¡æœ‰äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œepoll æ˜¯ä¸ä¼šäº§ç”Ÿè¿”å›å€¼çš„ï¼Œé¿å…äº†è½®è¯¢çš„è¿‡ç¨‹ã€‚

- é‡‡ç”¨äº†çº¢é»‘æ ‘çš„æ•°æ®ç»“æ„æ¥å­˜å‚¨æ–‡ä»¶æè¿°ç¬¦ï¼Œèƒ½å¤Ÿåœ¨æ·»åŠ å’Œåˆ é™¤äº‹ä»¶æ—¶æä¾› O(log n) çš„æ—¶é—´å¤æ‚åº¦ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥ä½¿ç”¨ EPOLLET æ¨¡å¼ï¼Œä»¥é¿å…å› ä¸ºæŸä¸ªæ–‡ä»¶æè¿°ç¬¦ä¸Šçš„äº‹ä»¶æœªå¤„ç†è€Œå¯¼è‡´çš„é¢‘ç¹è§¦å‘ epoll_wait() å‡½æ•°è°ƒç”¨ã€‚

æ€»çš„æ¥è¯´ï¼Œepoll æ¯” select å’Œ poll æ›´åŠ é«˜æ•ˆï¼Œå°¤å…¶æ˜¯åœ¨é«˜å¹¶å‘çš„ç½‘ç»œç¼–ç¨‹ä¸­ã€‚ä½†æ˜¯å®ƒä¹Ÿæœ‰ä¸€äº›ç¼ºç‚¹ï¼Œæ¯”å¦‚å¯¹ä»£ç çš„å¤æ‚åº¦è¦æ±‚æ¯”è¾ƒé«˜ï¼Œä¸æ˜“äºç†è§£å’Œè°ƒè¯•ã€‚



è¯¦ç»†åŒºåˆ«ï¼š

- è°ƒç”¨å‡½æ•°

- - select å’Œ poll éƒ½æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œepoll æ˜¯ä¸€ç»„å‡½æ•°

- æ–‡ä»¶æè¿°ç¬¦æ•°é‡

- - select é€šè¿‡çº¿æ€§è¡¨æè¿°æ–‡ä»¶æè¿°ç¬¦é›†åˆï¼Œæ–‡ä»¶æè¿°ç¬¦æœ‰ä¸Šé™ï¼Œä¸€èˆ¬æ˜¯ 1024ï¼Œä½†å¯ä»¥ä¿®æ”¹æºç ï¼Œé‡æ–°ç¼–è¯‘å†…æ ¸ï¼Œä¸æ¨è
  - poll æ˜¯é“¾è¡¨æè¿°ï¼Œçªç ´äº†æ–‡ä»¶æè¿°ç¬¦ä¸Šé™ï¼Œæœ€å¤§å¯ä»¥æ‰“å¼€æ–‡ä»¶çš„æ•°ç›®
  - epoll é€šè¿‡çº¢é»‘æ ‘æè¿°ï¼Œæœ€å¤§å¯ä»¥æ‰“å¼€æ–‡ä»¶çš„æ•°ç›®ï¼Œå¯ä»¥é€šè¿‡å‘½ä»¤ ulimit -n number ä¿®æ”¹ï¼Œä»…å¯¹å½“å‰ç»ˆç«¯æœ‰æ•ˆ

- å°†æ–‡ä»¶æè¿°ç¬¦ä»ç”¨æˆ·ä¼ ç»™å†…æ ¸

- - select å’Œ poll é€šè¿‡å°†æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦æ‹·è´åˆ°å†…æ ¸æ€ï¼Œæ¯æ¬¡è°ƒç”¨éƒ½éœ€è¦æ‹·è´
  - epoll é€šè¿‡ epoll_create å»ºç«‹ä¸€æ£µçº¢é»‘æ ‘ï¼Œé€šè¿‡ epoll_ctl å°†è¦ç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦æ³¨å†Œåˆ°çº¢é»‘æ ‘ä¸Š

- å†…æ ¸åˆ¤æ–­å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦

- - select å’Œ poll é€šè¿‡éå†æ–‡ä»¶æè¿°ç¬¦é›†åˆï¼Œåˆ¤æ–­å“ªä¸ªæ–‡ä»¶æè¿°ç¬¦ä¸Šæœ‰äº‹ä»¶å‘ç”Ÿ
  - epoll_create æ—¶ï¼Œå†…æ ¸é™¤äº†å¸®æˆ‘ä»¬åœ¨epollæ–‡ä»¶ç³»ç»Ÿé‡Œå»ºäº†ä¸ªçº¢é»‘æ ‘ç”¨äºå­˜å‚¨ä»¥å epoll_ctl ä¼ æ¥çš„ fd å¤–ï¼Œè¿˜ä¼šå†å»ºç«‹ä¸€ä¸ª list é“¾è¡¨ï¼Œç”¨äºå­˜å‚¨å‡†å¤‡å°±ç»ªçš„äº‹ä»¶ï¼Œå½“ epoll_wait è°ƒç”¨æ—¶ï¼Œä»…ä»…è§‚å¯Ÿè¿™ä¸ª list é“¾è¡¨é‡Œæœ‰æ²¡æœ‰æ•°æ®å³å¯ã€‚
  - epoll æ˜¯æ ¹æ®æ¯ä¸ª fd ä¸Šé¢çš„å›è°ƒå‡½æ•°(ä¸­æ–­å‡½æ•°)åˆ¤æ–­ï¼Œåªæœ‰å‘ç”Ÿäº†äº‹ä»¶çš„ socket æ‰ä¼šä¸»åŠ¨çš„å»è°ƒç”¨ callbackå‡½æ•°ï¼Œå…¶ä»–ç©ºé—²çŠ¶æ€ socket åˆ™ä¸ä¼šï¼Œè‹¥æ˜¯å°±ç»ªäº‹ä»¶ï¼Œæ’å…¥ list

- åº”ç”¨ç¨‹åºç´¢å¼•å°±ç»ªæ–‡ä»¶æè¿°ç¬¦

- - select/poll åªè¿”å›å‘ç”Ÿäº†äº‹ä»¶çš„æ–‡ä»¶æè¿°ç¬¦çš„ä¸ªæ•°ï¼Œè‹¥çŸ¥é“æ˜¯å“ªä¸ªå‘ç”Ÿäº†äº‹ä»¶ï¼ŒåŒæ ·éœ€è¦éå†
  - epoll è¿”å›çš„å‘ç”Ÿäº†äº‹ä»¶çš„ä¸ªæ•°å’Œç»“æ„ä½“æ•°ç»„ï¼Œç»“æ„ä½“åŒ…å« socket çš„ä¿¡æ¯ï¼Œå› æ­¤ç›´æ¥å¤„ç†è¿”å›çš„æ•°ç»„å³å¯

- å·¥ä½œæ¨¡å¼

- - select å’Œ poll éƒ½åªèƒ½å·¥ä½œåœ¨ç›¸å¯¹ä½æ•ˆçš„ LT æ¨¡å¼ä¸‹
  - epoll åˆ™å¯ä»¥å·¥ä½œåœ¨ ET é«˜æ•ˆæ¨¡å¼ï¼Œå¹¶ä¸” epoll è¿˜æ”¯æŒ EPOLLONESHOT äº‹ä»¶ï¼Œè¯¥äº‹ä»¶èƒ½è¿›ä¸€æ­¥å‡å°‘å¯è¯»ã€å¯å†™å’Œå¼‚å¸¸äº‹ä»¶è¢«è§¦å‘çš„æ¬¡æ•°ã€‚ 

- åº”ç”¨åœºæ™¯

- - å½“æ‰€æœ‰çš„ fd éƒ½æ˜¯æ´»è·ƒè¿æ¥ï¼Œä½¿ç”¨ epollï¼Œéœ€è¦å»ºç«‹æ–‡ä»¶ç³»ç»Ÿï¼Œçº¢é»‘æ ‘å’Œé“¾è¡¨å¯¹äºæ­¤æ¥è¯´ï¼Œæ•ˆç‡åè€Œä¸é«˜ï¼Œä¸å¦‚seleceå’Œpoll
  - å½“ç›‘æµ‹çš„ fd æ•°ç›®è¾ƒå°ï¼Œä¸”å„ä¸ª fd éƒ½æ¯”è¾ƒæ´»è·ƒï¼Œå»ºè®®ä½¿ç”¨ select æˆ–è€… poll
  - å½“ç›‘æµ‹çš„ fd æ•°ç›®éå¸¸å¤§ï¼Œæˆåƒä¸Šä¸‡ï¼Œä¸”å•ä½æ—¶é—´åªæœ‰å…¶ä¸­çš„ä¸€éƒ¨åˆ† fd å¤„äºå°±ç»ªçŠ¶æ€ï¼Œè¿™ä¸ªæ—¶å€™ä½¿ç”¨ epoll èƒ½å¤Ÿæ˜æ˜¾æå‡æ€§èƒ½



## ET å’Œ LT

ETå’ŒLTæ˜¯epollä¸­çš„ä¸¤ç§å·¥ä½œæ–¹å¼ï¼ŒæŒ‡å®šäº‹ä»¶è§¦å‘çš„æ¨¡å¼ã€‚

- LTï¼ˆLevel Triggeredï¼‰ï¼šå½“ä¸€ä¸ªäº‹ä»¶è¢«è§¦å‘åï¼Œå¦‚æœæ²¡æœ‰è¢«å¤„ç†ï¼Œä¸‹æ¬¡ epoll_wait ä»ç„¶ä¼šé€šçŸ¥ä½ ï¼Œç›´åˆ°è¿™ä¸ªäº‹ä»¶è¢«å¤„ç†ã€‚
- ETï¼ˆEdge Triggeredï¼‰ï¼šå½“ä¸€ä¸ªäº‹ä»¶è¢«è§¦å‘åï¼Œå¦‚æœæ²¡æœ‰è¢«å¤„ç†ï¼Œä¸‹æ¬¡ epoll_wait ä¸ä¼šå†é€šçŸ¥ä½ ï¼Œç›´åˆ°æ–°çš„äº‹ä»¶åˆ°æ¥ã€‚

ETæ˜¯ epoll çš„é«˜æ•ˆå·¥ä½œæ–¹å¼ï¼Œå®ƒåªé€šçŸ¥å‘ç”Ÿå˜åŒ–çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œä¸ä¼šé‡å¤é€šçŸ¥å·²ç»å¤„ç†è¿‡çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œä»è€Œå‡å°‘äº†ä¸å¿…è¦çš„ç³»ç»Ÿè°ƒç”¨ï¼Œæé«˜äº†æ•ˆç‡ã€‚ä½†æ˜¯ ET éœ€è¦ä¿è¯è¯»å†™ç¼“å†²åŒºè¢«ä¸€æ¬¡æ€§å¤„ç†å®Œæ•´ï¼Œå¦åˆ™ä¼šæœ‰é—æ¼ï¼Œå‡ºç°é—®é¢˜ã€‚å› æ­¤ï¼Œä½¿ç”¨ETæ—¶éœ€è¦æ³¨æ„ç¼“å†²åŒºçš„å¤„ç†ï¼Œå¿…é¡»è¦ä¸€æ¬¡æ€§å°†æ•°æ®è¯»å–å®Œï¼Œä½¿ç”¨éé˜»å¡ I/Oï¼Œè¯»å–åˆ°å‡ºç° eagainã€‚

- 

## EPOLLONESHOT

- æˆ‘ä»¬æœŸæœ›çš„æ˜¯ä¸€ä¸ªsocketè¿æ¥åœ¨ä»»ä¸€æ—¶åˆ»éƒ½åªè¢«ä¸€ä¸ªçº¿ç¨‹å¤„ç†ï¼Œé€šè¿‡epoll_ctlå¯¹è¯¥æ–‡ä»¶æè¿°ç¬¦æ³¨å†Œepolloneshotäº‹ä»¶ï¼Œä¸€ä¸ªçº¿ç¨‹å¤„ç†socketæ—¶ï¼Œå…¶ä»–çº¿ç¨‹å°†æ— æ³•å¤„ç†ï¼Œ**å½“è¯¥çº¿ç¨‹å¤„ç†å®Œåï¼Œéœ€è¦é€šè¿‡epoll_ctlé‡ç½®epolloneshotäº‹ä»¶**

- ä¸€ä¸ªçº¿ç¨‹è¯»å–æŸä¸ªsocketä¸Šçš„æ•°æ®åå¼€å§‹å¤„ç†æ•°æ®ï¼Œåœ¨å¤„ç†è¿‡ç¨‹ä¸­è¯¥socketä¸Šåˆæœ‰æ–°æ•°æ®å¯è¯»ï¼Œæ­¤æ—¶å¦ä¸€ä¸ªçº¿ç¨‹è¢«å”¤é†’è¯»å–ï¼Œæ­¤æ—¶å‡ºç°ä¸¤ä¸ªçº¿ç¨‹å¤„ç†åŒä¸€ä¸ªsocket





## å‚è€ƒ

- [æœ€æ–°ç‰ˆWebæœåŠ¡å™¨é¡¹ç›®è¯¦è§£ - 04 httpè¿æ¥å¤„ç†ï¼ˆä¸Šï¼‰](https://mp.weixin.qq.com/s/BfnNl-3jc_x5WPrWEJGdzQ)
- [æœ€æ–°ç‰ˆWebæœåŠ¡å™¨é¡¹ç›®è¯¦è§£ - 05 httpè¿æ¥å¤„ç†ï¼ˆä¸­ï¼‰](https://mp.weixin.qq.com/s/wAQHU-QZiRt1VACMZZjNlw)
- [æœ€æ–°ç‰ˆWebæœåŠ¡å™¨é¡¹ç›®è¯¦è§£ - 06 httpè¿æ¥å¤„ç†ï¼ˆä¸‹ï¼‰](https://mp.weixin.qq.com/s/451xNaSFHxcxfKlPBV3OCg)



## å†™åœ¨æœ€å

æ„Ÿè°¢ä½ åœ¨èŒ«èŒ«äººæµ·ä¸­æ‰¾åˆ°æˆ‘ğŸ•µğŸ¼

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">

<span id="busuanzi_container_page_pv">ğŸ‰ä½ æ˜¯ç¬¬ <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i>  </span> ä¸ªè¯»è€…

ãŠ—ï¸ ä½ å¹³å®‰å–œä¹ï¼Œé¡ºé‚æ— å¿§ï¼

å¸Œæœ›ä½ è¯»å®Œæœ‰æ‰€æ”¶è·ï½

ğŸ¥‚ğŸ¥‚ğŸ¥‚ 
